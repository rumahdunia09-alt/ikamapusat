<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IKAMAPUSAT - Cloud Kasir Manual Print</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        body { font-family: 'Segoe UI', sans-serif; margin: 20px; background: #f0f2f5; }
        .card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        input, button, select { padding: 12px; margin: 5px 0; border-radius: 6px; border: 1px solid #ddd; width: 100%; box-sizing: border-box; }
        button { cursor: pointer; background: #007bff; color: white; border: none; font-weight: bold; }
        button:hover { opacity: 0.9; }
        .btn-green { background: #28a745; }
        .btn-red { background: #dc3545; }
        .btn-print { background: #6c757d; font-size: 11px; padding: 5px; width: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { border: 1px solid #eee; padding: 10px; text-align: left; }
        th { background: #f8f9fa; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        @media (max-width: 768px) { .grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

    <div id="loginPage" class="card" style="max-width: 400px; margin: 80px auto;">
        <h2 style="text-align:center">IKAMAPUSAT CLOUD</h2>
        <input type="text" id="username" placeholder="Username">
        <input type="password" id="password" placeholder="Password">
        <button onclick="doLogin()">MASUK</button>
    </div>

    <div id="appContainer" style="display:none;">
        <div class="card" style="display:flex; justify-content:space-between; align-items:center">
            <h3>User: <span id="displayUser"></span></h3>
            <button class="btn-red" style="width:100px" onclick="location.reload()">LOGOUT</button>
        </div>

        <div class="grid">
            <div class="card">
                <h3>Kasir (Transaksi)</h3>
                <input type="text" id="scanKasir" placeholder="Scan Barcode / Nama Barang..." onkeypress="handleKasirScan(event)">
                <table>
                    <thead><tr><th>Produk</th><th>Qty</th><th>Subtotal</th></tr></thead>
                    <tbody id="bodyKeranjang"></tbody>
                </table>
                <h2 id="totalBelanja" style="text-align:right; color:#28a745">Total: Rp 0</h2>
                <button class="btn-green" onclick="prosesTransaksi()">SIMPAN TRANSAKSI</button>
            </div>

            <div class="card">
                <h3>Riwayat Penjualan</h3>
                <div style="max-height: 400px; overflow-y: auto;">
                    <table>
                        <thead><tr><th>Waktu</th><th>Total</th><th>Aksi</th></tr></thead>
                        <tbody id="bodyRiwayat"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="adminPanel" class="card" style="display:none">
            <h3>Manajemen Stok Barang</h3>
            <div class="grid">
                <div>
                    <input type="text" id="m_kode" placeholder="Barcode">
                    <input type="text" id="m_nama" placeholder="Nama Barang">
                    <input type="number" id="m_harga" placeholder="Harga Jual">
                    <input type="number" id="m_stok" placeholder="Stok">
                    <button class="btn-green" onclick="tambahBarang()">SIMPAN KE CLOUD</button>
                </div>
                <div style="max-height: 300px; overflow-y: auto;">
                    <table>
                        <thead><tr><th>Nama</th><th>Stok</th><th>Hapus</th></tr></thead>
                        <tbody id="bodyMaster"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyAvJdH3fnfUvupwtRDbSvhBjiY3tIxXnW0",
        authDomain: "kasir-ikamapusat.firebaseapp.com",
        databaseURL: "https://kasir-ikamapusat-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "kasir-ikamapusat",
        storageBucket: "kasir-ikamapusat.firebasestorage.app",
        messagingSenderId: "375649394523",
        appId: "1:375649394523:web:1e13212c1f9c1d8829447e"
    };

    firebase.initializeApp(firebaseConfig);
    const dbCloud = firebase.database();

    let dbBarang = [], dbUsers = [], dbRiwayat = [], keranjang = [], currentUser = null;

    dbCloud.ref('v9_barang').on('value', (snap) => { dbBarang = snap.val() || []; renderMaster(); });
    dbCloud.ref('v9_users').on('value', (snap) => { dbUsers = snap.val() || [{nama:'Owner Admin', user:'admin', pass:'123', role:'admin'}]; });
    dbCloud.ref('v9_riwayat').on('value', (snap) => { dbRiwayat = snap.val() || []; renderRiwayat(); });

    function doLogin() {
        const u = document.getElementById('username').value;
        const p = document.getElementById('password').value;
        const akun = dbUsers.find(x => x.user === u && x.pass === p);
        if(akun) {
            currentUser = akun;
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('appContainer').style.display = 'block';
            document.getElementById('displayUser').innerText = akun.nama;
            if(akun.role === 'admin') document.getElementById('adminPanel').style.display = 'block';
        } else { alert("Gagal!"); }
    }

    function handleKasirScan(e) {
        if(e.key === 'Enter') {
            const val = document.getElementById('scanKasir').value;
            const b = dbBarang.find(x => x.kode === val || x.nama === val);
            if(b && b.stok > 0) {
                const ada = keranjang.find(k => k.kode === b.kode);
                if(ada) { if(ada.qty < b.stok) ada.qty++; }
                else { keranjang.push({...b, qty: 1, jual: parseInt(b.harga)}); }
                renderKeranjang();
            }
            document.getElementById('scanKasir').value = '';
        }
    }

    function renderKeranjang() {
        const b = document.getElementById('bodyKeranjang');
        b.innerHTML = ''; let total = 0;
        keranjang.forEach(k => {
            let sub = k.qty * k.jual; total += sub;
            b.innerHTML += `<tr><td>${k.nama}</td><td>${k.qty}</td><td>Rp ${sub.toLocaleString()}</td></tr>`;
        });
        document.getElementById('totalBelanja').innerText = "Total: Rp " + total.toLocaleString();
    }

    function prosesTransaksi() {
        if(keranjang.length === 0) return;
        let totalTrx = 0;
        keranjang.forEach(item => {
            totalTrx += (item.qty * item.jual);
            const idx = dbBarang.findIndex(b => b.kode === item.kode);
            if(idx !== -1) dbBarang[idx].stok -= item.qty;
        });

        const trxBaru = { 
            id: "TRX-" + Date.now(),
            waktu: new Date().toLocaleString(), 
            total: totalTrx, 
            kasir: currentUser.nama,
            items: [...keranjang]
        };
        dbRiwayat.unshift(trxBaru);
        dbCloud.ref('v9_barang').set(dbBarang);
        dbCloud.ref('v9_riwayat').set(dbRiwayat);
        alert("Data Tersimpan ke Cloud!"); 
        keranjang = []; renderKeranjang();
    }

    function renderRiwayat() {
        const b = document.getElementById('bodyRiwayat'); b.innerHTML = '';
        dbRiwayat.slice(0,15).forEach((r, index) => {
            b.innerHTML += `<tr>
                <td>${r.waktu}</td>
                <td>Rp ${r.total.toLocaleString()}</td>
                <td><button class="btn-print" onclick="cetakManual(${index})">Cetak</button></td>
            </tr>`;
        });
    }

    function cetakManual(index) {
        const trx = dbRiwayat[index];
        let strukHTML = `
            <style>body{font-family:monospace;width:200px;font-size:12px}.c{text-align:center}.l{border-top:1px dashed #000;margin:5px 0}table{width:100%}</style>
            <div class="c"><strong>IKAMAPUSAT</strong><br>Struk Penjualan<br>${trx.waktu}</div>
            <div class="l"></div>
            <table>
                ${trx.items.map(it => `<tr><td>${it.nama} x${it.qty}</td><td align="right">${(it.jual*it.qty).toLocaleString()}</td></tr>`).join('')}
            </table>
            <div class="l"></div>
            <strong>TOTAL: Rp ${trx.total.toLocaleString()}</strong><br>
            <div class="c"><br>Terima Kasih</div>
        `;
        const win = window.open('', '_blank', 'width=300,height=400');
        win.document.write(strukHTML);
        win.document.close();
        win.print();
    }

    function tambahBarang() {
        const k = document.getElementById('m_kode').value;
        const n = document.getElementById('m_nama').value;
        const h = document.getElementById('m_harga').value;
        const s = document.getElementById('m_stok').value;
        if(!k || !n) return;
        dbBarang.push({kode:k, nama:n, harga:h, stok:s});
        dbCloud.ref('v9_barang').set(dbBarang);
        alert("Berhasil!");
    }

    function renderMaster() {
        const b = document.getElementById('bodyMaster'); b.innerHTML = '';
        dbBarang.forEach((brg, i) => {
            b.innerHTML += `<tr><td>${brg.nama}</td><td>${brg.stok}</td><td><button class="btn-red" style="padding:2px" onclick="hapusBarang(${i})">X</button></td></tr>`;
        });
    }

    function hapusBarang(i) { if(confirm("Hapus?")) { dbBarang.splice(i, 1); dbCloud.ref('v9_barang').set(dbBarang); } }
</script>
</body>
</html>
