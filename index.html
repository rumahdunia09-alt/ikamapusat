// --- DATABASE INITIALIZATION ---
let dbBarang = JSON.parse(localStorage.getItem('v9_barang')) || [];
let dbUsers = JSON.parse(localStorage.getItem('v9_users')) || [{nama:'Owner', user:'admin', pass:'123', role:'admin'}];
let dbRiwayat = JSON.parse(localStorage.getItem('v9_riwayat')) || [];
let keranjang = [];

// --- FUNGSI TRANSAKSI KASIR (PENYEMPURNAAN) ---

function handleKasirScan(e) {
    if(e.key === 'Enter') {
        const val = document.getElementById('scanKasir').value.trim();
        if(!val) return;

        // Cari berdasarkan kode atau nama
        const b = dbBarang.find(x => x.kode === val || x.nama.toLowerCase() === val.toLowerCase());
        
        if(b) {
            if(parseInt(b.stok) <= 0) {
                alert("Stok Habis!");
            } else {
                const ada = keranjang.find(k => k.kode === b.kode);
                if(ada) {
                    if(ada.qty < b.stok) {
                        ada.qty++;
                    } else {
                        alert("Stok tidak mencukupi!");
                    }
                } else {
                    keranjang.push({...b, qty: 1});
                }
                renderKeranjang();
            }
        } else {
            alert("Barang tidak ditemukan!");
        }
        document.getElementById('scanKasir').value = '';
    }
}

function renderKeranjang() {
    const t = document.getElementById('keranjangTabel');
    t.innerHTML = '';
    let total = 0;

    keranjang.forEach((k, i) => {
        let sub = k.jual * k.qty;
        total += sub;
        t.innerHTML += `
            <tr>
                <td>${k.nama}</td>
                <td>Rp ${k.jual.toLocaleString()}</td>
                <td>${k.qty}</td>
                <td>Rp ${sub.toLocaleString()}</td>
                <td><button class="btn btn-danger" style="padding: 2px 8px" onclick="hapusKeranjang(${i})">‚ùå</button></td>
            </tr>`;
    });

    document.getElementById('totalText').innerText = "Total: Rp " + total.toLocaleString();
    // Simpan angka asli total tanpa format ke dalam atribut data untuk kalkulasi
    document.getElementById('totalText').setAttribute('data-total', total);
    hitungKembalian();
}

function hapusKeranjang(i) {
    keranjang.splice(i, 1);
    renderKeranjang();
}

function hitungKembalian() {
    const total = parseInt(document.getElementById('totalText').getAttribute('data-total')) || 0;
    const bayar = parseInt(document.getElementById('uangBayar').value) || 0;
    const kembali = bayar - total;
    
    document.getElementById('kembaliText').innerText = "Kembali: Rp " + (kembali < 0 ? 0 : kembali).toLocaleString();
}

// --- FUNGSI SIMPAN & CETAK STRUK ---

function prosesTransaksi() {
    const total = parseInt(document.getElementById('totalText').getAttribute('data-total')) || 0;
    const bayar = parseInt(document.getElementById('uangBayar').value) || 0;

    if (keranjang.length === 0) return alert("Keranjang masih kosong!");
    if (!bayar || bayar < total) return alert("Uang bayar tidak cukup!");

    // 1. Update Stok Barang & Hitung Modal
    let totalModalTransaksi = 0;
    keranjang.forEach(item => {
        const indexBarang = dbBarang.findIndex(b => b.kode === item.kode);
        if (indexBarang !== -1) {
            dbBarang[indexBarang].stok = parseInt(dbBarang[indexBarang].stok) - item.qty;
            totalModalTransaksi += (parseInt(dbBarang[indexBarang].modal) * item.qty);
        }
    });

    // 2. Simpan ke Riwayat (Laporan)
    const dataTransaksi = {
        id: "TRX-" + Date.now(),
        waktu: new Date().toLocaleString('id-ID'),
        omzet: total,
        modal: totalModalTransaksi,
        laba: total - totalModalTransaksi,
        items: [...keranjang],
        bayar: bayar,
        kembali: bayar - total
    };

    dbRiwayat.unshift(dataTransaksi); // Simpan di urutan teratas

    // 3. Simpan Permanen ke LocalStorage
    localStorage.setItem('v9_barang', JSON.stringify(dbBarang));
    localStorage.setItem('v9_riwayat', JSON.stringify(dbRiwayat));

    // 4. Jalankan Fungsi Cetak
    cetakStruk(dataTransaksi);

    // 5. Reset Kasir
    alert("Transaksi Berhasil Disimpan!");
    keranjang = [];
    document.getElementById('uangBayar').value = '';
    renderKeranjang();
}

function cetakStruk(trx) {
    let strukHTML = `
        <div style="width: 300px; font-family: monospace; font-size: 12px; padding: 10px;">
            <div style="text-align: center;">
                <strong>IKAMAPUSAT</strong><br>
                Sistem Terpadu Kasir<br>
                --------------------------------<br>
                ${trx.waktu}<br>
                No: ${trx.id}<br>
                --------------------------------<br>
            </div>
            <table style="width: 100%; border-collapse: collapse;">
                ${trx.items.map(it => `
                    <tr>
                        <td colspan="2">${it.nama}</td>
                    </tr>
                    <tr>
                        <td>${it.qty} x ${it.jual.toLocaleString()}</td>
                        <td style="text-align: right;">${(it.qty * it.jual).toLocaleString()}</td>
                    </tr>
                `).join('')}
            </table>
            --------------------------------<br>
            <table style="width: 100%;">
                <tr><td>TOTAL</td><td style="text-align: right;">Rp ${trx.omzet.toLocaleString()}</td></tr>
                <tr><td>BAYAR</td><td style="text-align: right;">Rp ${trx.bayar.toLocaleString()}</td></tr>
                <tr><td>KEMBALI</td><td style="text-align: right;">Rp ${trx.kembali.toLocaleString()}</td></tr>
            </table>
            --------------------------------<br>
            <div style="text-align: center;">
                Terima Kasih Atas Kunjungan Anda
            </div>
        </div>
    `;

    // Membuka jendela cetak baru
    const printWindow = window.open('', '', 'width=400,height=600');
    printWindow.document.write('<html><head><title>Struk Belanja</title></head><body>');
    printWindow.document.write(strukHTML);
    printWindow.document.write('</body></html>');
    printWindow.document.close();
    printWindow.print();
    printWindow.close();
}
